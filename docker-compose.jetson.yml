version: "3.9"

services:
  mcp_server:
    build: ./jetson/mcp_server
    container_name: jetson_mcp
    restart: unless-stopped
    ports:
      - "${JETSON_MCP_PORT}:8000"
    volumes:
      - ./jetson/mcp_server/data:/app/data
      - /dev/video0:/dev/video0
    environment:
      - TZ=${GENERIC_TIMEZONE}
    devices:
      - /dev/video0:/dev/video0

  jetson_camera:
    image: python:3.10-slim
    container_name: jetson_camera
    restart: unless-stopped
    volumes:
      - ./jetson/mcp_server/scripts:/app/scripts
    working_dir: /app/scripts
    command: ["python", "jetson_camera.py"]
    devices:
      - /dev/video0:/dev/video0
    environment:
      - SERVER_WS=ws://mcp_server:8000/mcp/ws

  jetson_audio:
    image: python:3.10-slim
    container_name: jetson_audio
    restart: unless-stopped
    volumes:
      - ./jetson/mcp_server/scripts:/app/scripts
      - /dev/snd:/dev/snd
    working_dir: /app/scripts
    command: ["python", "jetson_audio.py"]
    environment:
      - SERVER_WS=ws://${JETSON_IP}:${AGENT_SYSTEM_PORT}/mcp/ws


  tony_agents:
    build: .
    container_name: tony_agents
    restart: always
    ports:
      - "5050:${AGENT_MASTER_PORT}"  # Master / voice command
      - "5051:${AGENT_SPEAKER_PORT}"  # Speaker
      - "8000:${AGENT_SYSTEM_PORT}"  # System / Camera
    devices:
      - "/dev/video0:/dev/video0"  # Cam√©ra
      - "/dev/snd:/dev/snd"        # Micro / audio
    volumes:
      - /mnt/ssd/jetson_data:/app/data
      - /mnt/ssd/models:/app/models
    environment:
      - OLLAMA_HOST=http://${OLLAMA_IP}:${OLLAMA_PORT}
      - JETSON_MODE=production
    command: ["python3", "start_agents.py"]
    runtime: nvidia

networks:
  default:
    driver: bridge
